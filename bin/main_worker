#!/usr/bin/env node

import {
  UPDATE_USER_BUSINESS,

  SET_PASSWORD,
  UPDATE_ACCOUNT_SETTINGS,
  RESEND_EMAIL_VERIFICATION,
  PASSWORD_RESET,
  SIGN_UP,
  CHANGE_EMAIL,

  AUTHORIZE_MANAGER,
  REVOKE_MANAGER_AUTHORIZATION,

  ADD_DOC,
  DELETE_DOC,
  RESTORE_DOC,
  SET_MANAGER,
  SET_STATE,
  CLOSE_DOC,
  CANCEL_DOC,

  // Payments
  SET_PAY,
  DEL_PAY,

  // Files
  UPLOAD_FILE,
  DELETE_FILE,
  RESTORE_FILE,
} from 'backend/constants';

import config from 'build/config';

import * as businessOps from 'backend/ops/business';
import * as authOps from 'backend/ops/auth';
import * as docOps from 'backend/ops/doc';

import createWorker from 'backend/kue-mq/createWorker';

const log = require('log')('app:backend:main_worker');

const opts = {
  ...config.kue_opts,
  concurrency : 1,
};

createWorker({ ...opts, concurrency : require('os').cpus().length }, 'AUTH', {
  // auth
  [SET_PASSWORD]              : authOps.setPassword,
  [UPDATE_ACCOUNT_SETTINGS]   : authOps.updateAccountSettings,
  [RESEND_EMAIL_VERIFICATION] : authOps.resendEmailVerification,
  [PASSWORD_RESET]            : authOps.passwordReset,
  [SIGN_UP]                   : authOps.signUp,
  [CHANGE_EMAIL]              : authOps.changeEmail,

});

createWorker(opts, 'MAIN', {
  [UPDATE_USER_BUSINESS] : businessOps.updateUserBusiness,

  [AUTHORIZE_MANAGER]            : authOps.authorizeManager,
  [REVOKE_MANAGER_AUTHORIZATION] : authOps.revokeManagerAuthorization,

  // Docs
  [ADD_DOC]     : docOps.addDoc,
  [DELETE_DOC]  : docOps.delDoc,
  [RESTORE_DOC] : docOps.restoreDoc,
  [SET_MANAGER] : docOps.setManager,
  [SET_STATE]   : docOps.setState,
  [CLOSE_DOC]   : docOps.closeDoc,
  [CANCEL_DOC]  : docOps.cancelDoc,

  // Payments
  [SET_PAY]  : docOps.setPay,
  [DEL_PAY]  : docOps.delPay,

  // Files
  [UPLOAD_FILE]  : docOps.uploadFile,
  [DELETE_FILE]  : docOps.delFile,
  [RESTORE_FILE] : docOps.restoreFile,
});

